<?php

/**
 * @file
 * Provides integration between the SMS Framework and Drupal users.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\sms\Entity\SmsMessageInterface as SmsMessageEntityInterface;
use Drupal\sms\Message\SmsMessageInterface;
use Drupal\sms\Entity\SmsMessage as SmsMessageEntity;
use Drupal\sms\Entity\PhoneNumberSettingsInterface;

/**
 * Implements hook_entity_presave().
 */
function sms_user_entity_presave(EntityInterface $entity) {
  // Delay sending SMS message if active hours are enabled.
  if ($entity instanceof SmsMessageEntityInterface) {
    /** @var \Drupal\sms_user\ActiveHoursInterface $active_hours */
    $active_hours = \Drupal::service('sms_user.active_hours');
    $active_hours->delaySmsMessage($entity);
  }
}

/**
 * Implements hook_entity_insert().
 */
function sms_user_entity_insert(EntityInterface $entity) {
  // Rebuild dynamic menu links if phone number settings for 'user' added.
  if ($entity instanceof PhoneNumberSettingsInterface && $entity->getPhoneNumberEntityTypeId() == 'user') {
    /** @var \Drupal\Core\Menu\MenuLinkManagerInterface $menu_link */
    $menu_link = \Drupal::service('plugin.manager.menu.link');
    $menu_link->rebuild();
  }
}

/**
 * Implements hook_sms_incoming().
 */
function sms_user_sms_incoming_preprocess(SmsMessageInterface $sms_message) {
  /** @var \Drupal\sms_user\AccountRegistrationInterface $account_registration */
  $account_registration = \Drupal::service('sms_user.account_registration');

  // Upgrade standard SMS message to entity.
  // @todo Remove after ->createAccount works with standard SMS messages
  // @see https://www.drupal.org/node/2709469
  $sms_message = SmsMessageEntity::convertFromSmsMessage($sms_message);

  $account_registration->createAccount($sms_message);
}
